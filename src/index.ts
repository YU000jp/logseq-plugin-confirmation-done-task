import "@logseq/libs" //https://plugins-doc.logseq.com/
import { AppInfo, BlockEntity, BlockUUID, LSPluginBaseInfo, } from "@logseq/libs/dist/LSPlugin.user"
import { setup as l10nSetup, t } from "logseq-l10n" //https://github.com/sethyuan/logseq-l10n
import { pushDONE } from "./block"
import { showDialogProcess } from "./dialog"
import { removeDialog, removeProvideStyle, renamePage } from "./lib"
import { settingsTemplate } from "./settings"
import { provideStyleMain } from "./style"
import af from "./translations/af.json"
import de from "./translations/de.json"
import es from "./translations/es.json"
import fr from "./translations/fr.json"
import id from "./translations/id.json"
import it from "./translations/it.json"
import ja from "./translations/ja.json"
import ko from "./translations/ko.json"
import nbNO from "./translations/nb-NO.json"
import nl from "./translations/nl.json"
import pl from "./translations/pl.json"
import ptBR from "./translations/pt-BR.json"
import ptPT from "./translations/pt-PT.json"
import ru from "./translations/ru.json"
import sk from "./translations/sk.json"
import tr from "./translations/tr.json"
import uk from "./translations/uk.json"
import zhCN from "./translations/zh-CN.json"
import zhHant from "./translations/zh-Hant.json"
import { cancelledTask, waitingTask, doingTask, todoTask, doneTask } from "./otherTask"
export const keySmallDONEproperty = "not-smallDONEproperty"
export const keyStyle = "DONEpluginMain"
export const keySettingsButton = "DONEpluginSettingsButton"
export const key = "DONEdialog"
let onBlockChangedToggle: boolean = false
let processingButton: boolean = false

let configPreferredDateFormat: string
export const getConfigPreferredDateFormat = (): string => configPreferredDateFormat


const getUserConfig = async () => {
  const { preferredDateFormat } = await logseq.App.getUserConfigs() as { preferredDateFormat: string }
  configPreferredDateFormat = preferredDateFormat
}

let logseqVersion: string = "" //„Éê„Éº„Ç∏„Éß„É≥„ÉÅ„Çß„ÉÉ„ÇØÁî®
let logseqVersionMd: boolean = false //„Éê„Éº„Ç∏„Éß„É≥„ÉÅ„Çß„ÉÉ„ÇØÁî®
let logseqDbGraph: boolean = false
// export const getLogseqVersion = () => logseqVersion //„Éê„Éº„Ç∏„Éß„É≥„ÉÅ„Çß„ÉÉ„ÇØÁî®
export const booleanLogseqVersionMd = () => logseqVersionMd //„Éê„Éº„Ç∏„Éß„É≥„ÉÅ„Çß„ÉÉ„ÇØÁî®
export const booleanDbGraph = () => logseqDbGraph //„Éê„Éº„Ç∏„Éß„É≥„ÉÅ„Çß„ÉÉ„ÇØÁî®

export interface TaskBlockEntity {
  // id: EntityID;
  uuid: BlockUUID
  // left: IEntityID;
  // format: 'markdown' | 'org';
  // parent: IEntityID;
  content: string
  // page: IEntityID;
  properties?: Record<string, any>
  // anchor?: string;
  // body?: any;
  // children?: Array<BlockEntity | BlockUUIDTuple>;
  // container?: string;
  // file?: IEntityID;
  // level?: number;
  // meta?: {
  //     timestamps: any;
  //     properties: any;
  //     startPos: number;
  //     endPos: number;
  // };
  // title?: Array<any>;
  marker?: string
  // [key: string]: unknown;
}


/* main */
const main = async (notFirst?: boolean) => {

  // „Éê„Éº„Ç∏„Éß„É≥„ÉÅ„Çß„ÉÉ„ÇØ
  if (notFirst !== true)
    logseqVersionMd = await checkLogseqVersion()
  // console.log("logseq version: ", logseqVersion)
  // console.log("logseq version is MD model: ", logseqVersionMd)
  // 100msÂæÖ„Å§
  await new Promise(resolve => setTimeout(resolve, 100))

  // if (logseqVersionMd === false) {
  //   // Logseq ver 0.10.*‰ª•‰∏ã„Å´„Åó„ÅãÂØæÂøú„Åó„Å¶„ÅÑ„Å™„ÅÑ
  //   logseq.UI.showMsg("The ‚ÄôBullet Point Custom Icon‚Äô plugin only supports Logseq ver 0.10.* and below.", "warning", { timeout: 5000 })
  //   return
  // }
  // // DB„Ç∞„É©„Éï„ÉÅ„Çß„ÉÉ„ÇØ
  logseqDbGraph = await checkLogseqDbGraph()
  if (logseqDbGraph === true) {
    // DB„Ç∞„É©„Éï„Å´„ÅØÂØæÂøú„Åó„Å¶„ÅÑ„Å™„ÅÑ
    return showDbGraphIncompatibilityMsg()
  }

  //100msÂæÖ„Å§
  await new Promise(resolve => setTimeout(resolve, 100))

  logseq.App.onCurrentGraphChanged(async () => {
    logseqDbGraph = await checkLogseqDbGraph()
    if (logseqDbGraph === true)
      // DB„Ç∞„É©„Éï„Å´„ÅØÂØæÂøú„Åó„Å¶„ÅÑ„Å™„ÅÑ
      return showDbGraphIncompatibilityMsg()
  })

  await l10nSetup({
    builtinTranslations: {//Full translations
      ja, af, de, es, fr, id, it, ko, "nb-NO": nbNO, nl, pl, "pt-BR": ptBR, "pt-PT": ptPT, ru, sk, tr, uk, "zh-CN": zhCN, "zh-Hant": zhHant
    }
  })

  await getUserConfig()

  /* user settings */
  logseq.useSettingsSchema(settingsTemplate())
  const updateInfo = "20250323a"
  if (!logseq.settings)
    setTimeout(() => logseq.showSettingsUI(), 300)
  else
    if (logseq.settings!.updateInfo !== updateInfo) {
      setTimeout(() => logseq.showSettingsUI(), 300)
      logseq.updateSettings({ updateInfo })
    }


  provideStyleMain(logseq.settings!.upperDONEproperty as boolean, logseqVersionMd)

  //„Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÊôÇ
  logseq.App.onPageHeadActionsSlotted(() => startOnBlock())
  logseq.App.onRouteChanged(() => startOnBlock())

  //„Ç∞„É©„ÉïÂ§âÊõ¥ÊôÇ
  logseq.App.onCurrentGraphChanged(() => {
    getUserConfig()
    startOnBlock()
  })

  const startOnBlock = () => {
    removeDialog()
    if (onBlockChangedToggle === false) {
      onBlockChanged()
      onBlockChangedToggle = true
    }
  }


  onBlockChanged()
  onBlockChangedToggle = true
  //end


  // DONE„Å´„Åô„Çã„Ç≥„Éû„É≥„Éâ
  if (logseq.settings!.enableDoneCommand as boolean === true) {
    const registerDoneCommand = (key: string, label: string, keybinding: string, mode: string) => {
      logseq.App.registerCommandPalette({
        key,
        label: "‚úîÔ∏è " + t(label),
        keybinding: { binding: keybinding }
      }, async () => {
        const block = await logseq.Editor.getCurrentBlock() as TaskBlockEntity | null
        if (!block) return
        const modeSelect = logseq.settings!.modeSelect as string || "As block property"
        logseq.updateSettings({ modeSelect: mode })
        pushDONE(block)
        setTimeout(() => logseq.updateSettings({ modeSelect }), 1000)
        logseq.UI.showMsg("‚úîÔ∏è " + t("Set to DONE"), "success", { timeout: 3000, })
      })
    }
    // Register commands
    registerDoneCommand("setToDoneDefault", "Set to DONE  (default mode)", "", "As block property")
    registerDoneCommand("setToDoneBlockProperty", "Set to DONE  `As block property`", "", "As block property")
    registerDoneCommand("setToDoneInsert", "Set to DONE  `Insert block`", "", "Insert block")
    registerDoneCommand("setToDoneUpdate", "Set to DONE  `Update block`", "", "Update block")
  }

  //„Éó„É≠„Éë„ÉÜ„Ç£„ÅÆ‰∏≠„Å´„ÄÅÊó•‰ªò„ÇíÈÄ£Á∂ö„ÅßËøΩÂä†„Åô„Çã
  if (logseq.settings!.addDateContinuously as boolean === true)
    logseq.Editor.registerBlockContextMenuItem(`üí™ ${t("Add date into DONE property")}`, async ({ uuid }) => {
      const block = await logseq.Editor.getBlock(uuid) as TaskBlockEntity | null
      if (!block) return
      // Êù°‰ª∂
      if (block.marker === "DONE" // DONE„Çø„Çπ„ÇØ
        && block.properties // „Éó„É≠„Éë„ÉÜ„Ç£„Åå„ÅÇ„Çã
        && block.properties[logseq.settings!.customPropertyName as string || "completed"] // „Éó„É≠„Éë„ÉÜ„Ç£„Å´ÊåáÂÆö„ÅÆ„Éó„É≠„Éë„ÉÜ„Ç£„Åå„ÅÇ„Çã
      ) showDialog(block, true, `üí™ ${t("Add date into DONE property")}`)
      else
        logseq.UI.showMsg(t("This is not a DONE task with the \"completed\" property"), "warning")
    })

  //Set to DONE
  logseq.Editor.registerBlockContextMenuItem(`üí™ ${t("Set to DONE")}`, async ({ uuid }) => {
    const block = (await logseq.Editor.getBlock(uuid)) as TaskBlockEntity | null
    if (!block) return
    if (block.marker === "DONE")
      showDialog(block, false, `üí™ ${t("Set to DONE")}`)
    else {
      //DONE„Çø„Çπ„ÇØ„Åß„ÅØ„Å™„Åã„Å£„ÅüÂ†¥Âêà„ÄÅDONE„Å´„Åô„Çã
      pushDONE(block)
      logseq.UI.showMsg(t("Set to DONE"), "success", { timeout: 3000, })
    }
  })

  if (logseq.settings!.smallDONEproperty === false)
    parent.document.body.classList.add(keySmallDONEproperty)


  // „Éó„É©„Ç∞„Ç§„É≥Ë®≠ÂÆö„ÅÆÈ†ÖÁõÆÂ§âÊõ¥ÊôÇ
  logseq.onSettingsChanged((newSet: LSPluginBaseInfo["settings"], oldSet: LSPluginBaseInfo["settings"]) => {

    //Ë¶ã„ÅüÁõÆ„ÅÆÂ§âÊõ¥
    if (oldSet.smallDONEproperty === false
      && newSet.smallDONEproperty === true)
      parent.document.body.classList!.remove(keySmallDONEproperty)
    else
      if (oldSet.smallDONEproperty === true
        && newSet.smallDONEproperty === false)
        parent.document.body.classList!.add(keySmallDONEproperty)

    //DONE„Éó„É≠„Éë„ÉÜ„Ç£„ÅÆÂêçÁß∞Â§âÊõ¥
    if (oldSet.customPropertyName !== newSet.customPropertyName)
      renamePage(oldSet.customPropertyName as string, newSet.customPropertyName as string)

    // CANCELED„Éó„É≠„Éë„ÉÜ„Ç£„ÅÆÂêçÁß∞Â§âÊõ¥
    if (oldSet.cancelledTaskPropertyName !== newSet.cancelledTaskPropertyName)
      renamePage(oldSet.cancelledTaskPropertyName as string, newSet.cancelledTaskPropertyName as string)

    // WAITING„Éó„É≠„Éë„ÉÜ„Ç£„ÅÆÂêçÁß∞Â§âÊõ¥
    if (oldSet.waitingTaskPropertyName !== newSet.waitingTaskPropertyName)
      renamePage(oldSet.waitingTaskPropertyName as string, newSet.waitingTaskPropertyName as string)

    // DOING„Éó„É≠„Éë„ÉÜ„Ç£„ÅÆÂêçÁß∞Â§âÊõ¥
    if (oldSet.doingTaskPropertyName !== newSet.doingTaskPropertyName)
      renamePage(oldSet.doingTaskPropertyName as string, newSet.doingTaskPropertyName as string)

    // TODO„Éó„É≠„Éë„ÉÜ„Ç£„ÅÆÂêçÁß∞Â§âÊõ¥
    if (oldSet.todoTaskPropertyName !== newSet.todoTaskPropertyName)
      renamePage(oldSet.todoTaskPropertyName as string, newSet.todoTaskPropertyName as string)

    // „Éà„Ç∞„É´
    if (newSet.upperDONEproperty !== oldSet.upperDONEproperty) {
      if (newSet.upperDONEproperty === true)
        provideStyleMain(newSet.upperDONEproperty as boolean, logseqVersionMd)
      else
        removeProvideStyle(keyStyle)
    }
  })

  logseq.provideModel({
    [keySettingsButton]: () => logseq.showSettingsUI(),
  })

} /* end_main */



//add completed property to done task
//https://github.com/DimitryDushkin/logseq-plugin-task-check-date
const onBlockChanged = () =>
  logseq.DB.onChanged(async ({ blocks, txMeta }) => {

    if (logseq.settings!.onlyFromBulletList === true // „Éñ„É≠„ÉÉ„ÇØÊìç‰Ωú„Å´„Çà„Çã„ÇÇ„ÅÆ„Åß„ÅØ„Å™„ÅÑÂ†¥Âêà
      || processingButton === true //Âá¶ÁêÜ‰∏≠„ÅÆÂ†¥Âêà 
      || (txMeta
        && (txMeta["transact?"] === false //„É¶„Éº„Ç∂„ÉºÊìç‰Ωú„Åß„ÅØ„Å™„ÅÑÂ†¥Âêà (transact„ÅØÂèñÂºï„ÅÆÊÑèÂë≥)
          || txMeta?.outlinerOp === "delete-blocks")) //„Éñ„É≠„ÉÉ„ÇØ„ÅåÂâäÈô§„Åï„Çå„ÅüÂ†¥Âêà
    ) return //Âá¶ÁêÜ„Åó„Å™„ÅÑ

    processingButton = true

    //DONE„Çø„Çπ„ÇØ„Åß„ÅØ„Å™„ÅÑ„ÅÆ„Å´„ÄÅcompleted„Éó„É≠„Éë„ÉÜ„Ç£(„Åù„Çå„Å´Áõ∏ÂΩì„Åô„Çã)„Çí„ÇÇ„Å§Â†¥Âêà„ÅØÂâäÈô§„Åô„Çã
    if (logseq.settings!.removePropertyWithoutDONEtask === true) {
      const CompletedOff: TaskBlockEntity | undefined = blocks.find(({ marker, properties }) =>
        marker !== "DONE"// DONE„Çø„Çπ„ÇØ„Åß„ÅØ„Å™„ÅÑ
        && properties
        && properties[logseq.settings!.customPropertyName as string || "completed"] // „Éó„É≠„Éë„ÉÜ„Ç£„Å´ÊåáÂÆö„ÅÆ„Éó„É≠„Éë„ÉÜ„Ç£„Åå„ÅÇ„Çã„Åã„ÄÅcompleted„Éó„É≠„Éë„ÉÜ„Ç£„Åå„ÅÇ„Çã„Åã
      ) as BlockEntity | undefined

      //Ë¶ã„Å§„Åã„Å£„ÅüÂ†¥Âêà„ÅØÂâäÈô§„Åô„Çã
      if (CompletedOff) {
        //„Éó„É≠„Éë„ÉÜ„Ç£„ÇíÂâäÈô§„Åô„Çã
        logseq.Editor.removeBlockProperty(CompletedOff.uuid, logseq.settings!.customPropertyName as string || "completed")
        //string„Éó„É≠„Éë„ÉÜ„Ç£„ÇÇÂâäÈô§„Åô„Çã
        if (CompletedOff.properties!.string)
          logseq.Editor.removeBlockProperty(CompletedOff.uuid, "string")
      }
    }

    //CANCELLED„Çø„Çπ„ÇØ„Åß„ÅØ„Å™„ÅÑ„ÅÆ„Å´„ÄÅcancelled„Éó„É≠„Éë„ÉÜ„Ç£(„Åù„Çå„Å´Áõ∏ÂΩì„Åô„Çã)„Çí„ÇÇ„Å§Â†¥Âêà„ÅØÂâäÈô§„Åô„Çã
    if (logseq.settings!.removePropertyWithoutCANCELLEDtask === true) {
      const canceledOff: TaskBlockEntity | undefined = blocks.find(({ marker, properties }) =>
        marker !== "CANCELED" // CANCELLED„Çø„Çπ„ÇØ„Åß„ÅØ„Å™„ÅÑ
        && marker !== "CANCELLED" // CANCELLED„Çø„Çπ„ÇØ„Åß„ÅØ„Å™„ÅÑ
        && properties
        && properties[logseq.settings!.cancelledTaskPropertyName as string || "cancelled"] // „Éó„É≠„Éë„ÉÜ„Ç£„Å´ÊåáÂÆö„ÅÆ„Éó„É≠„Éë„ÉÜ„Ç£„Åå„ÅÇ„Çã„Åã„ÄÅcancelled„Éó„É≠„Éë„ÉÜ„Ç£„Åå„ÅÇ„Çã„Åã
      ) as BlockEntity | undefined

      //Ë¶ã„Å§„Åã„Å£„ÅüÂ†¥Âêà„ÅØÂâäÈô§„Åô„Çã
      if (canceledOff) {
        //„Éó„É≠„Éë„ÉÜ„Ç£„ÇíÂâäÈô§„Åô„Çã
        logseq.Editor.removeBlockProperty(canceledOff.uuid, logseq.settings!.cancelledTaskPropertyName as string || "cancelled")
        //string„Éó„É≠„Éë„ÉÜ„Ç£„ÇÇÂâäÈô§„Åô„Çã
        if (canceledOff.properties!.string)
          logseq.Editor.removeBlockProperty(canceledOff.uuid, "string")
      }
    }

    //WAITING„Çø„Çπ„ÇØ„Åß„ÅØ„Å™„ÅÑ„ÅÆ„Å´„ÄÅwaiting„Éó„É≠„Éë„ÉÜ„Ç£(„Åù„Çå„Å´Áõ∏ÂΩì„Åô„Çã)„Çí„ÇÇ„Å§Â†¥Âêà„ÅØÂâäÈô§„Åô„Çã
    if (logseq.settings!.removePropertyWithoutWAITINGtask === true) {
      const waitingOff: TaskBlockEntity | undefined = blocks.find(({ marker, properties }) =>
        marker !== "WAITING" // WAITING„Çø„Çπ„ÇØ„Åß„ÅØ„Å™„ÅÑ
        && properties
        && properties[logseq.settings!.waitingTaskPropertyName as string || "waiting"] // „Éó„É≠„Éë„ÉÜ„Ç£„Å´ÊåáÂÆö„ÅÆ„Éó„É≠„Éë„ÉÜ„Ç£„Åå„ÅÇ„Çã„Åã„ÄÅwaiting„Éó„É≠„Éë„ÉÜ„Ç£„Åå„ÅÇ„Çã„Åã
      ) as BlockEntity | undefined

      //Ë¶ã„Å§„Åã„Å£„ÅüÂ†¥Âêà„ÅØÂâäÈô§„Åô„Çã
      if (waitingOff) {
        //„Éó„É≠„Éë„ÉÜ„Ç£„ÇíÂâäÈô§„Åô„Çã
        logseq.Editor.removeBlockProperty(waitingOff.uuid, logseq.settings!.waitingTaskPropertyName as string || "waiting")
        //string„Éó„É≠„Éë„ÉÜ„Ç£„ÇÇÂâäÈô§„Åô„Çã
        if (waitingOff.properties!.string)
          logseq.Editor.removeBlockProperty(waitingOff.uuid, "string")
      }
    }

    //DOING„Çø„Çπ„ÇØ„Åß„ÅØ„Å™„ÅÑ„ÅÆ„Å´„ÄÅdoing„Éó„É≠„Éë„ÉÜ„Ç£(„Åù„Çå„Å´Áõ∏ÂΩì„Åô„Çã)„Çí„ÇÇ„Å§Â†¥Âêà„ÅØÂâäÈô§„Åô„Çã
    if (logseq.settings!.removePropertyWithoutDOINGtask === true) {
      const doingOff: TaskBlockEntity | undefined = blocks.find(({ marker, properties }) =>
        marker !== "DOING" // DOING„Çø„Çπ„ÇØ„Åß„ÅØ„Å™„ÅÑ
        && properties
        && properties[logseq.settings!.doingTaskPropertyName as string || "during"] // „Éó„É≠„Éë„ÉÜ„Ç£„Å´ÊåáÂÆö„ÅÆ„Éó„É≠„Éë„ÉÜ„Ç£„Åå„ÅÇ„Çã„Åã„ÄÅduring„Éó„É≠„Éë„ÉÜ„Ç£„Åå„ÅÇ„Çã„Åã
      ) as BlockEntity | undefined

      //Ë¶ã„Å§„Åã„Å£„ÅüÂ†¥Âêà„ÅØÂâäÈô§„Åô„Çã
      if (doingOff) {
        //„Éó„É≠„Éë„ÉÜ„Ç£„ÇíÂâäÈô§„Åô„Çã
        logseq.Editor.removeBlockProperty(doingOff.uuid, logseq.settings!.doingTaskPropertyName as string || "during")
        //string„Éó„É≠„Éë„ÉÜ„Ç£„ÇÇÂâäÈô§„Åô„Çã
        if (doingOff.properties!.string)
          logseq.Editor.removeBlockProperty(doingOff.uuid, "string")
      }
    }

    //TODO„Çø„Çπ„ÇØ„Åß„ÅØ„Å™„ÅÑ„ÅÆ„Å´„ÄÅcreated„Éó„É≠„Éë„ÉÜ„Ç£(„Åù„Çå„Å´Áõ∏ÂΩì„Åô„Çã)„Çí„ÇÇ„Å§Â†¥Âêà„ÅØÂâäÈô§„Åô„Çã
    if (logseq.settings!.removePropertyWithoutTODOtask === true) {
      const todoOff: TaskBlockEntity | undefined = blocks.find(({ marker, properties }) =>
        marker !== "TODO" // TODO„Çø„Çπ„ÇØ„Åß„ÅØ„Å™„ÅÑ
        && properties
        && properties[logseq.settings!.todoTaskPropertyName as string || "created"] // „Éó„É≠„Éë„ÉÜ„Ç£„Å´ÊåáÂÆö„ÅÆ„Éó„É≠„Éë„ÉÜ„Ç£„Åå„ÅÇ„Çã„Åã„ÄÅcreated„Éó„É≠„Éë„ÉÜ„Ç£„Åå„ÅÇ„Çã„Åã
      ) as BlockEntity | undefined

      //Ë¶ã„Å§„Åã„Å£„ÅüÂ†¥Âêà„ÅØÂâäÈô§„Åô„Çã
      if (todoOff) {
        //„Éó„É≠„Éë„ÉÜ„Ç£„ÇíÂâäÈô§„Åô„Çã
        logseq.Editor.removeBlockProperty(todoOff.uuid, logseq.settings!.todoTaskPropertyName as string || "created")
        //string„Éó„É≠„Éë„ÉÜ„Ç£„ÇÇÂâäÈô§„Åô„Çã
        if (todoOff.properties!.string)
          logseq.Editor.removeBlockProperty(todoOff.uuid, "string")
      }
    }

    // „Çø„Çπ„ÇØ„Çí„ÇÇ„Å§„Éñ„É≠„ÉÉ„ÇØ„Åå„ÅÇ„Çã„Åã„Å©„ÅÜ„Åã
    const taskBlock: TaskBlockEntity | undefined = blocks.find(({ marker }) =>
      (logseq.settings!.DONEtask as boolean === true
        && marker === "DONE")
      || (logseq.settings!.cancelledTask as boolean === true
        && (marker === "CANCELED"
          || marker === "CANCELLED"))
      || (logseq.settings!.waitingTask as boolean === true
        && marker === "WAITING")
      || (logseq.settings!.doingTask as boolean === true
        && marker === "DOING")
      || (logseq.settings!.todoTask as boolean === true
        && marker === "TODO")) //TODO„Çø„Çπ„ÇØ„ÇíÂèñÂæó„Åô„Çã
    //saveBlock‰ª•Â§ñ„ÅØÂá¶ÁêÜ„Åó„Å™„ÅÑ
    if (!taskBlock) {
      setTimeout(() => processingButton = false, 100)
      return
    } else {
      //„ÉÅ„Çß„ÉÉ„ÇØ„Éú„Çø„É≥„Åã„Çâ„ÅÆÂ†¥Âêà„ÅØ„ÄÅÁèæÂú®„ÅÆ„Éñ„É≠„ÉÉ„ÇØ„Å®‰∏ÄËá¥„Åó„Å™„ÅÑ

      //„ÉÄ„Ç§„Ç¢„É≠„Ç∞„ÇíË°®Á§∫
      if (logseq.settings!.DONEtask as boolean === true
        && taskBlock.marker === "DONE") {
        if (logseq.settings!.useDialog as boolean === true)
          showDialog(taskBlock, false)
        else
          if (!(taskBlock.properties
            && taskBlock.properties[logseq.settings!.customPropertyName as string || "completed"]))
            doneTask(taskBlock) //DONE„Çø„Çπ„ÇØ„Å´„Éó„É≠„Éë„ÉÜ„Ç£„ÇíËøΩÂä†„Åô„Çã („ÉÄ„Ç§„Ç¢„É≠„Ç∞„Çí‰Ωø„Çè„Å™„ÅÑ„Åß„Åù„ÅÆ„Åæ„ÅæÂá¶ÁêÜ)
      } else
        if (taskBlock.properties)
          if ((logseq.settings!.cancelledTask as boolean === true
            && (taskBlock.marker === "CANCELED"
              || taskBlock.marker === "CANCELLED")
            && !taskBlock.properties[logseq.settings!.cancelledTaskPropertyName as string || "cancelled"]))
            cancelledTask(taskBlock) //CANCELLED„Çø„Çπ„ÇØ„Å´„Éó„É≠„Éë„ÉÜ„Ç£„ÇíËøΩÂä†„Åô„Çã („ÉÄ„Ç§„Ç¢„É≠„Ç∞„Çí‰Ωø„Çè„Å™„ÅÑ„Åß„Åù„ÅÆ„Åæ„ÅæÂá¶ÁêÜ)
          else
            if ((logseq.settings!.waitingTask as boolean === true
              && taskBlock.marker === "WAITING"
              && !taskBlock.properties[logseq.settings!.waitingTaskPropertyName as string || "waiting"]))
              waitingTask(taskBlock) //WAITING„Çø„Çπ„ÇØ„Å´„Éó„É≠„Éë„ÉÜ„Ç£„ÇíËøΩÂä†„Åô„Çã („ÉÄ„Ç§„Ç¢„É≠„Ç∞„Çí‰Ωø„Çè„Å™„ÅÑ„Åß„Åù„ÅÆ„Åæ„ÅæÂá¶ÁêÜ)
            else
              if ((logseq.settings!.doingTask as boolean === true
                && taskBlock.marker === "DOING"
                && !taskBlock.properties[logseq.settings!.doingTaskPropertyName as string || "during"]))
                doingTask(taskBlock) //DOING„Çø„Çπ„ÇØ„Å´„Éó„É≠„Éë„ÉÜ„Ç£„ÇíËøΩÂä†„Åô„Çã („ÉÄ„Ç§„Ç¢„É≠„Ç∞„Çí‰Ωø„Çè„Å™„ÅÑ„Åß„Åù„ÅÆ„Åæ„ÅæÂá¶ÁêÜ)
              else
                if ((logseq.settings!.todoTask as boolean === true
                  && taskBlock.marker === "TODO"
                  && !taskBlock.properties[logseq.settings!.todoTaskPropertyName as string || "created"]))
                  todoTask(taskBlock) //TODO„Çø„Çπ„ÇØ„Å´„Éó„É≠„Éë„ÉÜ„Ç£„ÇíËøΩÂä†„Åô„Çã („ÉÄ„Ç§„Ç¢„É≠„Ç∞„Çí‰Ωø„Çè„Å™„ÅÑ„Åß„Åù„ÅÆ„Åæ„ÅæÂá¶ÁêÜ)


      setTimeout(() => processingButton = false, 300)
    }
  })


let processingShowDialog: Boolean = false
const showDialog = async (taskBlock: TaskBlockEntity, additional: Boolean, addTitle?: string) => {
  if (additional === false
    && taskBlock.properties![logseq.settings!.customPropertyName as string || "completed"]) return //„Åô„Åß„Å´„Éó„É≠„Éë„ÉÜ„Ç£„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØËøΩÂä†„Åó„Å™„ÅÑ

  //„Éñ„É≠„ÉÉ„ÇØÊìç‰Ωú„ÅßDONE„Åß„ÅØ„Å™„Åè„Å™„Å£„ÅüÂ†¥Âêà
  logseq.DB.onBlockChanged(taskBlock.uuid, async (block: TaskBlockEntity) => {
    //DONE„ÇíÂÖ•Âäõ„Åó„Å¶„Åã„Çâ„Éñ„É≠„ÉÉ„ÇØ„Åß„Ç≠„É£„É≥„Çª„É´„Åó„ÅüÂ†¥Âêà„Å´„ÉÄ„Ç§„Ç¢„É≠„Ç∞„ÇíÊ∂à„Åô
    if (block.marker !== "DONE") removeDialog()
  })

  if (processingShowDialog === true
    || parent.document.getElementById(`${logseq.baseInfo.id}--${key}`) as HTMLDivElement) return //„Åô„Åß„Å´„ÉÄ„Ç§„Ç¢„É≠„Ç∞„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØËøΩÂä†„Åó„Å™„ÅÑ
  processingShowDialog = true
  //„ÉÄ„Ç§„Ç¢„É≠„Ç∞„ÇíË°®Á§∫
  await showDialogProcess(taskBlock, addTitle, additional) //„É≠„ÉÉ„ÇØËß£Èô§
  setTimeout(() => processingShowDialog = false, 1000)

} //end showDialog


// MD„É¢„Éá„É´„Åã„Å©„ÅÜ„Åã„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØ DB„É¢„Éá„É´„ÅØfalse
const checkLogseqVersion = async (): Promise<boolean> => {
  const logseqInfo = (await logseq.App.getInfo("version")) as AppInfo | any
  //  0.11.0„ÇÇ„Åó„Åè„ÅØ0.11.0-alpha+nightly.20250427„ÅÆ„Çà„ÅÜ„Å™ÂΩ¢Âºè„Å™„ÅÆ„Åß„ÄÅÂÖàÈ†≠„ÅÆ3„Å§„ÅÆÊï∞ÂÄ§(1Ê°Å„ÄÅ2Ê°Å„ÄÅ2Ê°Å)„ÇíÊ≠£Ë¶èË°®Áèæ„ÅßÂèñÂæó„Åô„Çã
  const version = logseqInfo.match(/(\d+)\.(\d+)\.(\d+)/)
  if (version) {
    logseqVersion = version[0] //„Éê„Éº„Ç∏„Éß„É≥„ÇíÂèñÂæó
    // console.log("logseq version: ", logseqVersion)

    // „ÇÇ„Åó „Éê„Éº„Ç∏„Éß„É≥„Åå0.10.*Á≥ª„ÇÑ„Åù„Çå‰ª•‰∏ã„Å™„Çâ„Å∞„ÄÅlogseqVersionMd„Çítrue„Å´„Åô„Çã
    if (logseqVersion.match(/0\.([0-9]|10)\.\d+/)) {
      logseqVersionMd = true
      // console.log("logseq version is 0.10.* or lower")
      return true
    } else logseqVersionMd = false
  } else logseqVersion = "0.0.0"
  return false
}
// DB„Ç∞„É©„Éï„Åã„Å©„ÅÜ„Åã„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØ
// DB„Ç∞„É©„Éï„Åã„Å©„ÅÜ„Åã„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØ DB„Ç∞„É©„Éï„Å†„Åëtrue
const checkLogseqDbGraph = async (): Promise<boolean> => {
  const element = parent.document.querySelector(
    "div.block-tags",
  ) as HTMLDivElement | null // „Éö„Éº„Ç∏ÂÜÖ„Å´Class„Çø„Ç∞„ÅåÂ≠òÂú®„Åô„Çã  WARN:: ‚ÄªDOMÂ§âÊõ¥„ÅÆÂèØËÉΩÊÄß„Å´Ê≥®ÊÑè
  if (element) {
    logseqDbGraph = true
    return true
  } else logseqDbGraph = false
  return false
}

const showDbGraphIncompatibilityMsg = () => {
  logseq.UI.showMsg("The ‚ÄôDONE task property‚Äô plugin not supports Logseq DB graph.", "warning", { timeout: 5000 })
  return
}

logseq.ready(main).catch(console.error)